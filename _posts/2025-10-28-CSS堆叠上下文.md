---
title: CSS堆叠上下文
date: 2025-10-27 00:00:00 +0800 # YYYY-MM-DD HH:MM:SS +/-TTTT 2022-01-01 13:14:15 +0800 只写日期也行；不写秒也行；这样也行 2022-03-09T00:55:42+08:00
categories: ["编程"]
tags: ["CSS"]     # TAG names should always be lowercase

media_subpath: "/assets/img/posts/2025-10-28-CSS堆叠上下文"

math: true
mermaid: true
---

> 问题：如果页面上有个元素不见了，该怎么办？
# CSS渲染

CSS渲染就像广告牌上贴广告，一层贴一层，同一片区域最终被看见的，是贴在最上层的。
从程序角度来讲，贴在最上层指的是元素的 stacking-level 值最大的。
![alt text](image.png)

## stacking-level
渲染DOM元素时，为了确保渲染覆盖顺序符合预期的效果，通过为每个DOM元素计算一个 stacking-level 值，渲染时根据 stacking-level 的值从小到大依次渲染每个DOM元素。这个渲染过程就像是按照元素的 stacking-level 值贴广告，stacking-level 值小的元素先贴上去，stacking-level 值大的元素后贴上去，最终效果就是 stacking-level 值大的DOM元素可能会遮盖 stacking-level 值小的DOM元素（如果有重叠部分的话）。

如果两个DOM元素 stacking-level 值相等，渲染顺序是这两个DOM元素在源代码中的书写顺序。最终效果是写在后面的DOM元素可能会遮盖写在前面的DOM元素（如果有重叠部分的话）。

stacking-level是一个计算值，实际不存在这个属性，因此无法通过API获取。
![alt text](image-1.png)

实际代码中是这样：
```html 
    <div id="container">
        <div style="position: relative;">
            <div style="position: absolute; width: 300px; height: 500px; background-color: red;"></div>
            <div style="position: absolute; width: 500px; height: 300px; background-color: blue;"></div>
        </div>
    </div>
```
效果如下：
![alt text](image-4.png)

> 结论：stacking-level 决定最终元素的渲染顺序
- stacking-level 值大的DOM元素会覆盖 stacking-level 值小的DOM元素
- stacking-level 值相等时，后面的 DOM 元素会覆盖前面的 DOM 元素

## stacking-order
stacking-order 是定义元素渲染顺序的规则，从 stacking-level 的角度来讲，什么样的元素 stacking-level 更大呢？如下图：
![alt text](image-3.png)

越外层的元素 stacking-level 值越大。
实际测试结果和上图有出入，实际测试结果如下图：
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Stacking Order 实验</title>
<style>
  body {
    background: #eee;
  }
  /* 1️⃣ 背景层 */
  #container {
    position: relative;
    width: 800px;
    height: 600px;
    border: 5px solid #333;
    margin: 50px auto;
    background: #a47ab9;
  }

  /* 2️⃣ z-index < 0 的定位元素 */
  .neg-index {
    position: absolute;
    top: 0px;
    left: 0px;
    width: 300px;
    height: 300px;
    background: #d84e3d;
    z-index: -1;
  }

  /* 3️⃣ 块级元素 */
  .block-box {
    display: block;
    position: absolute;
    top: 50px;
    left: 50px;
    width: 300px;
    height: 300px;
    background-color: #597fbf;
  }

  /* 4️⃣ 非定位块级元素 + 浮动 */
  .float-block {
    float: left;
    width: 300px;
    height: 500px;
    margin-top: 100px;
    margin-left: 100px;
    background: #de9a48;
  }

  /* 5️⃣ 非定位行内元素 */
  .inline {
    display: inline;
    background: #aac358;
    font-size: 50px;
    color: white;
    position: relative;
    top: 150px;
    left: -300px
  }

  /* 6️⃣ z-index: auto（未指定）定位元素 */
  .auto-index {
    position: absolute;
    top: 200px;
    left: 200px;
    width: 300px;
    height: 300px;
    background: #70c1ad;
  }

  /* 7️⃣ z-index >= 0 的定位元素 */
  .pos-index {
    position: absolute;
    top: 250px;
    left: 250px;
    width: 300px;
    height: 300px;
    background: #597fbf;
    z-index: 10;
  }
</style>
</head>
<body>
  <div id="container">1 背景层
    <div class="neg-index">2 z-index&lt;0</div>
    <div class="block-box">3 块元素</div>
    <div class="float-block">4 块级浮动</div>
    <div class="inline">5 行内元素=======</div>
    <div class="auto-index">6 z-index:auto</div>
    <div class="pos-index">7 z-index≥0</div>
  </div>
</body>
</html>
```
![alt text](image-6.png)
> 结论：元素类型及部分 css 属性影响元素的 stacking-level
- 一般我们常用的是通过 z-index 设置让元素显示在上面，原理就是随着 z-index 的增加，元素的 stacking-level 值增加。
- 如果我们知道 stacking-order，也可以通过例如行内元素显示在块元素上这种技巧修改覆盖顺序。

> 控制元素的 stacking-order 的方式是通过给元素设置布局或者 z-index 属性。

## stacking-context
类似于 stacking-order，stacking-context也是通过影响元素的 stacking-level 值从而影响元素的渲染顺序的。不过 stacking-order 影响的是在同一块广告牌上贴的顺序，而 stacking-context 相当于直接在前面又挡了一个广告牌。

![alt text](image-8.png)

如上图所示，如果一个广告牌被另外一个广告牌挡住，下层的广告牌上的广告顺序即使再靠前，也不如上层广告牌最下层的广告。

![alt text](image-7.png)

> 总结：stacking-context 是影响元素渲染覆盖顺序的主要因素。在相同 stacking-context 内的 stacking-order 比较才有意义。

> 控制元素 stacking-context 的方式有很多，以下方式都可以为元素生成一层 stacking-context。元素的 stacking-context 越多，就相当于挡的广告牌越多。
1. 文档的根元素（<html>）。
2. position具有值absolute或relative以及z-index除auto值之外的值的元素。
3. position具有值fixed或sticky的元素。
4. container-type具有值size或集合的元素inline-size。
5. 具有除z-index:auto之外的值的flex元素。
6. 具有除z-index:auto之外的值的gride元素。
7. opacity值小于1的元素。
8. mix-blend-mode具有除normal之外的值的元素。
9. 具有以下任一属性且值为none以外的值的元素：
- transform
- scale
- rotate
- translate
- filter
- backdrop-filter
- perspective
- clip-path
- mask/mask-image/mask-border
10. isolation值为isolate的元素。
11. 元素的will-change值指定了将在非初始值上创建堆叠上下文的任何属性。
12. contain值为layout或paint的元素，或包含其中任一值的复合值（即 contain: strict）contain: content。
13. 放置在顶层的元素及其对应的::backdrop。示例包括全屏和弹出元素。
14. 具有堆叠上下文创建属性（例如opacity）的元素使用@keyframes进行动画处理，并将animation-fill-mode设置为forwards。